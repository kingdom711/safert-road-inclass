---
description: Safety Road API 구현 시 Swagger 기반 검증 및 테스트 필수 규칙
globs: ["**/*Controller.java", "**/*Service.java", "**/*.tsx", "**/*.ts"]
alwaysApply: false
---
# Swagger API Testing Rules - Safety Road

## 개요
**모든 API 구현 완료 후, 반드시 Swagger UI를 통해 요청/응답 포맷을 확인하고 실제 시험 호출을 수행해야 합니다.**

이 규칙은 API의 정확성, 문서화 품질, 프론트엔드 연동 안정성을 보장하기 위한 필수 검증 절차입니다.

---

## 1. 사전 준비: 서버 실행 및 Swagger 접속

### 1.1 백엔드 서버 실행
```bash
# Windows
cd backend
.\gradlew.bat bootRun

# Linux/Mac
cd backend
./gradlew bootRun
```

### 1.2 Swagger UI 접속
- **URL**: `http://localhost:8080/swagger-ui/index.html`
- **API Docs (JSON)**: `http://localhost:8080/api-docs`
- **헬스체크**: `http://localhost:8080/api/v1/health`

**접속 확인:**
- [ ] Swagger UI 페이지가 정상적으로 로드되는가?
- [ ] 좌측에 API 그룹(Tags)이 표시되는가?
- [ ] 우측 상단에 "Authorize" 버튼이 보이는가?

---

## 2. API 문서화 확인 (구현 완료 후 필수 체크)

### 2.1 Controller 어노테이션 확인
**Swagger UI에서 해당 API가 표시되는지 확인:**

```java
@Tag(name = "Checklist", description = "체크리스트 관리 API")
@RestController
@RequestMapping("/api/v1/checklists")
@RequiredArgsConstructor
public class ChecklistController {
    
    @Operation(
        summary = "체크리스트 제출",
        description = "작업자가 현장에서 작성한 체크리스트를 제출합니다."
    )
    @ApiResponses({
        @ApiResponse(responseCode = "201", description = "제출 성공"),
        @ApiResponse(responseCode = "400", description = "검증 실패"),
        @ApiResponse(responseCode = "401", description = "인증 실패")
    })
    @PostMapping(consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ApiResponse<ChecklistResponse> submitChecklist(...) {
        // ...
    }
}
```

**체크리스트:**
- [ ] Swagger UI에서 해당 API 엔드포인트가 표시되는가?
- [ ] `@Tag`로 그룹화되어 올바른 카테고리에 있는가?
- [ ] `@Operation`의 summary와 description이 표시되는가?
- [ ] `@ApiResponses`로 응답 코드가 문서화되어 있는가?

### 2.2 DTO 필드 문서화 확인
**Request/Response DTO에 `@Schema` 어노테이션이 있는지 확인:**

```java
@Schema(description = "체크리스트 제출 요청")
@Getter
@NoArgsConstructor
public class ChecklistRequest {
    
    @Schema(description = "템플릿 ID", example = "1", required = true)
    @NotNull(message = "템플릿 ID는 필수입니다")
    private Long templateId;
    
    @Schema(description = "작업 현장명", example = "삼성전자 기흥캠퍼스", required = true)
    @NotBlank(message = "작업 현장명은 필수입니다")
    private String siteName;
    
    @Schema(description = "작업 일자", example = "2025-12-20", required = true)
    @NotNull(message = "작업 일자는 필수입니다")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate workDate;
}
```

**체크리스트:**
- [ ] Request Body의 각 필드에 설명(description)이 표시되는가?
- [ ] 예시 값(example)이 제공되는가?
- [ ] 필수 필드(required: true)가 명확히 표시되는가?
- [ ] 필드 타입이 올바른가? (string, number, boolean, array, object)
- [ ] enum 타입인 경우 모든 가능한 값이 표시되는가?

---

## 3. Swagger UI에서 예시 요청/응답 포맷 확인

### 3.1 Request Body 예시 확인 절차

**Step 1: API 선택**
1. Swagger UI 좌측에서 해당 API 그룹(Tag) 클릭
2. 원하는 API 엔드포인트 찾기

**Step 2: "Try it out" 버튼 클릭**
- API 상세 화면에서 "Try it out" 버튼 클릭
- Request Body 입력 필드가 표시됨

**Step 3: 예시 값 확인**
- Swagger가 자동으로 생성한 예시 값 확인
- "Example Value" 또는 "Schema" 탭에서 구조 확인

**예시: POST /api/v1/checklists**
```json
{
  "templateId": 1,
  "siteName": "삼성전자 기흥캠퍼스",
  "workDate": "2025-12-20",
  "items": [
    {
      "itemId": 1,
      "answer": "yes",
      "comment": ""
    },
    {
      "itemId": 2,
      "answer": "no",
      "comment": "사다리 고정 미흡"
    }
  ]
}
```

**확인 사항:**
- [ ] 필수 필드가 명확히 표시되는가? (required: true)
- [ ] 필드 타입이 올바른가? (string, number, boolean, array, object)
- [ ] 예시 값(example)이 제공되는가?
- [ ] 중첩 객체(nested object)의 구조가 올바른가?
- [ ] 배열 타입의 경우 배열 요소 구조가 명확한가?

### 3.2 Response 예시 확인 절차

**Step 1: "Responses" 섹션 확인**
- API 상세 화면 하단의 "Responses" 섹션 확인
- 각 HTTP 상태 코드별 응답 예시 확인

**Step 2: "Example Value" 또는 "Schema" 탭 확인**
- 성공 응답(200/201)의 예시 값 확인
- 에러 응답(400/401/403/404)의 예시 값 확인

**성공 응답 예시:**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "status": "submitted",
    "createdAt": "2025-12-20T14:30:00.000+09:00",
    "siteName": "삼성전자 기흥캠퍼스",
    "items": [
      {
        "itemId": 1,
        "answer": "yes",
        "comment": ""
      }
    ]
  },
  "error": null
}
```

**에러 응답 예시:**
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "VALIDATION_FAILED",
    "message": "입력 값 검증 실패",
    "details": {
      "siteName": "작업 현장명은 필수입니다"
    }
  }
}
```

**확인 사항:**
- [ ] `ApiResponse<T>` 래퍼 구조가 올바른가? (`success`, `data`, `error`)
- [ ] `data` 필드의 타입이 예상과 일치하는가?
- [ ] 날짜/시간 형식이 ISO-8601인가? (`yyyy-MM-dd'T'HH:mm:ss.SSSXXX`)
- [ ] 에러 응답도 문서화되어 있는가? (400, 401, 403, 404 등)
- [ ] 에러 응답의 구조가 일관된가? (`code`, `message`, `details`)

---

## 4. Swagger UI에서 실제 시험 호출 수행 (필수)

### 4.1 인증 토큰 발급 (인증이 필요한 API인 경우)

**Step 1: 로그인 API 호출**
1. Swagger UI에서 `POST /api/v1/auth/login` 찾기
2. "Try it out" 버튼 클릭
3. Request Body 입력:
```json
{
  "username": "worker1",
  "password": "password123"
}
```
4. "Execute" 버튼 클릭

**Step 2: 토큰 복사**
- 응답에서 `accessToken` 값 복사
- 예: `"accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."`

**Step 3: 토큰 설정**
1. Swagger UI 우측 상단 "Authorize" 버튼 클릭
2. "Value" 필드에 `Bearer {accessToken}` 형식으로 입력
   - 예: `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
3. "Authorize" 버튼 클릭
4. "Close" 버튼 클릭

**확인 사항:**
- [ ] 로그인 API 호출 시 200 응답을 받았는가?
- [ ] `accessToken`과 `refreshToken`이 응답에 포함되어 있는가?
- [ ] "Authorize" 버튼으로 토큰을 설정할 수 있는가?
- [ ] 토큰 설정 후 "Authorized" 표시가 나타나는가?

### 4.2 API 시험 호출 절차

**Step 1: API 선택 및 "Try it out" 클릭**
- Swagger UI에서 테스트할 API 찾기
- "Try it out" 버튼 클릭

**Step 2: Request Body 작성 (POST/PUT/PATCH인 경우)**
- Swagger가 제공하는 예시 값을 기반으로 작성
- 필수 필드는 반드시 포함
- 선택 필드는 생략 가능하지만, 다양한 케이스 테스트 권장

**Step 3: Query Parameters 설정 (GET인 경우)**
- 페이징: `page=0&size=20&sort=createdAt,desc`
- 필터링: `status=submitted&workDate=2025-12-20`

**Step 4: "Execute" 버튼 클릭**
- 요청 전송
- 응답 대기

**Step 5: 응답 확인**
- **Status Code**: 200, 201, 400, 401, 403, 404 등
- **Response Body**: JSON 구조 및 값 확인
- **Response Headers**: `Content-Type: application/json` 확인

### 4.3 시험 호출 검증 체크리스트

#### 성공 케이스 (200/201)
- [ ] **HTTP 상태 코드가 200 또는 201인가?**
- [ ] **Response Body가 예상한 구조인가?**
  - `success: true`
  - `data` 필드에 예상한 값이 포함되어 있는가?
  - 날짜/시간 형식이 올바른가? (`2025-12-20T14:30:00.000+09:00`)
- [ ] **필드명이 camelCase인가?** (예: `checklistId`, `createdAt`)
- [ ] **null 값이 올바르게 처리되는가?** (null로 표시되거나 필드가 누락)
- [ ] **배열/리스트가 올바르게 반환되는가?**
- [ ] **중첩 객체가 올바르게 반환되는가?**

#### 검증 실패 케이스 (400 Bad Request)
**테스트 시나리오:**
1. 필수 필드 누락
2. 잘못된 타입 입력 (문자열을 숫자 필드에 입력)
3. 잘못된 형식 입력 (날짜 형식 오류)
4. 범위를 벗어난 값 입력

**확인 사항:**
- [ ] **400 Bad Request가 올바르게 반환되는가?**
- [ ] **에러 응답 구조가 일관된가?**
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "VALIDATION_FAILED",
    "message": "입력 값 검증 실패",
    "details": {
      "templateId": "템플릿 ID는 필수입니다",
      "siteName": "작업 현장명은 필수입니다"
    }
  }
}
```
- [ ] **필드별 에러 메시지가 명확한가?**
- [ ] **에러 메시지가 사용자 친화적인가?**

#### 인증/인가 오류 케이스
**테스트 시나리오:**
1. 토큰 없이 호출 (401 Unauthorized)
2. 만료된 토큰으로 호출 (401 Unauthorized)
3. 권한이 없는 사용자의 토큰으로 호출 (403 Forbidden)

**확인 사항:**
- [ ] **401 Unauthorized** (토큰 없음/만료)
- [ ] **403 Forbidden** (권한 부족)
- [ ] **에러 응답에 적절한 메시지가 포함되어 있는가?**

#### 리소스 없음 케이스 (404 Not Found)
**테스트 시나리오:**
- 존재하지 않는 ID로 조회 (예: `GET /api/v1/checklists/99999`)

**확인 사항:**
- [ ] **404 Not Found가 올바르게 반환되는가?**
- [ ] **에러 메시지가 명확한가?**
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "CHECKLIST_NOT_FOUND",
    "message": "체크리스트를 찾을 수 없습니다. ID: 99999"
  }
}
```

---

## 5. API별 시험 호출 시나리오

### 5.1 인증 API (`/api/v1/auth/**`)

#### 로그인 (POST /api/v1/auth/login)
```json
Request:
{
  "username": "worker1",
  "password": "password123"
}
Expected: 200 OK
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "username": "worker1",
      "name": "김대리",
      "role": "ROLE_WORKER"
    }
  }
}
```

#### 내 정보 조회 (GET /api/v1/auth/me)
- **Headers**: `Authorization: Bearer {accessToken}`
- **Expected**: 200 OK, 사용자 정보

### 5.2 체크리스트 API (`/api/v1/checklists/**`)

#### 체크리스트 제출 (POST /api/v1/checklists)
- **Content-Type**: `multipart/form-data`
- **Request Part 1**: `request` (JSON)
```json
{
  "templateId": 1,
  "siteName": "삼성전자 기흥캠퍼스",
  "workDate": "2025-12-20",
  "items": [
    {
      "itemId": 1,
      "answer": "yes",
      "comment": ""
    },
    {
      "itemId": 2,
      "answer": "no",
      "comment": "사다리 고정 미흡"
    }
  ]
}
```
- **Request Part 2**: `files` (선택, 이미지 파일)
- **Expected**: 201 Created, ChecklistResponse

#### 내 체크리스트 목록 (GET /api/v1/checklists/my)
- **Query Params**: `?page=0&size=20&sort=createdAt,desc`
- **Expected**: 200 OK, Page<ChecklistListResponse>

#### 체크리스트 상세 (GET /api/v1/checklists/{id})
- **Path Variable**: `id` (체크리스트 ID)
- **Expected**: 200 OK, ChecklistResponse

### 5.3 위험성 평가 API (`/api/v1/risks/**`)

#### 평가 대상 조회 (GET /api/v1/risks/pending)
- **Expected**: 200 OK, List<PendingRiskResponse>

#### 위험성 평가 등록 (POST /api/v1/risks/{checklistItemId}/assess)
```json
Request:
{
  "frequency": "OCCASIONAL",
  "severity": "MODERATE",
  "countermeasure": "안전장치 설치"
}
Expected: 201 Created, RiskAssessmentResponse
```

---

## 6. Swagger 문서화 품질 기준

### 6.1 Controller 필수 어노테이션
```java
@Tag(name = "Checklist", description = "체크리스트 관리 API")
@RestController
@RequestMapping("/api/v1/checklists")
@RequiredArgsConstructor
public class ChecklistController {
    
    @Operation(
        summary = "체크리스트 제출",
        description = "작업자가 현장에서 작성한 체크리스트를 제출합니다. " +
                     "사진 파일은 선택적으로 첨부할 수 있습니다."
    )
    @ApiResponses({
        @ApiResponse(
            responseCode = "201",
            description = "체크리스트 제출 성공",
            content = @Content(schema = @Schema(implementation = ChecklistResponse.class))
        ),
        @ApiResponse(
            responseCode = "400",
            description = "필수 항목 누락 또는 검증 실패",
            content = @Content(schema = @Schema(implementation = ApiResponse.class))
        ),
        @ApiResponse(
            responseCode = "401",
            description = "인증 실패 (JWT 토큰 없음/만료)"
        )
    })
    @PostMapping(consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ApiResponse<ChecklistResponse> submitChecklist(
        @Parameter(hidden = true) @AuthenticationPrincipal User currentUser,
        @Valid @RequestPart("request") ChecklistRequest request,
        @RequestPart(value = "files", required = false) List<MultipartFile> files
    ) {
        // ...
    }
}
```

### 6.2 DTO 필드 문서화
```java
@Schema(description = "체크리스트 제출 요청")
@Getter
@NoArgsConstructor
public class ChecklistRequest {
    
    @Schema(description = "템플릿 ID", example = "1", required = true)
    @NotNull(message = "템플릿 ID는 필수입니다")
    private Long templateId;
    
    @Schema(description = "작업 현장명", example = "삼성전자 기흥캠퍼스", required = true)
    @NotBlank(message = "작업 현장명은 필수입니다")
    private String siteName;
    
    @Schema(description = "작업 일자", example = "2025-12-20", required = true)
    @NotNull(message = "작업 일자는 필수입니다")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate workDate;
    
    @Schema(description = "체크리스트 항목 목록", required = true)
    @NotEmpty(message = "체크리스트 항목은 최소 1개 이상 필요합니다")
    @Valid
    private List<ChecklistItemRequest> items;
}
```

---

## 7. 문제 발견 시 조치 사항

### 7.1 Swagger에 API가 표시되지 않는 경우
**원인:**
- Controller가 `@RestController` 또는 `@Controller`로 등록되지 않음
- `@RequestMapping` 경로가 잘못됨
- Spring Component Scan 범위에 포함되지 않음

**조치:**
1. Controller 클래스 어노테이션 확인
2. 패키지 구조 확인 (`com.jinsung.safety_road_inclass` 하위인지)
3. 서버 재시작

### 7.2 요청/응답 DTO가 표시되지 않는 경우
**원인:**
- DTO 클래스가 public이 아님
- Lombok `@Getter`, `@Setter` 누락
- `@Schema` 어노테이션 누락

**조치:**
1. DTO 클래스 접근 제어자 확인 (public)
2. Lombok 어노테이션 확인
3. `@Schema` 어노테이션 추가

### 7.3 시험 호출 시 500 에러 발생
**원인:**
- 서버 로그 확인 필요
- 데이터베이스 연결 문제
- 비즈니스 로직 예외 처리 누락

**조치:**
1. 서버 콘솔 로그 확인
2. `GlobalExceptionHandler`에 예외 처리 추가
3. 데이터베이스 연결 상태 확인

### 7.4 응답 구조가 예상과 다른 경우
**원인:**
- `ApiResponse<T>` 래퍼 미사용
- DTO 매핑 오류
- Jackson 직렬화 설정 문제

**조치:**
1. Controller에서 `ApiResponse.success(data)` 사용 확인
2. DTO 매핑 로직 확인
3. `application.properties`의 Jackson 설정 확인

---

## 8. Swagger 테스트 최종 체크리스트

API 구현 완료 후 다음 체크리스트를 **모두 완료**해야 합니다:

### 필수 확인 사항
- [ ] Swagger UI 접속 성공 (`http://localhost:8080/swagger-ui/index.html`)
- [ ] 해당 API가 Swagger에 표시됨
- [ ] `@Operation`, `@ApiResponses` 어노테이션으로 문서화 완료
- [ ] Request Body 예시 값 확인
- [ ] Response Body 예시 값 확인
- [ ] 필수/선택 필드 구분 명확
- [ ] 인증 필요한 API는 "Authorize" 버튼으로 토큰 설정 가능

### 필수 시험 호출
- [ ] **성공 케이스**: 200/201 응답, 올바른 Response Body
- [ ] **검증 실패 케이스**: 400 응답, 에러 메시지 확인
- [ ] **인증 실패 케이스**: 401 응답 (토큰 없음/만료)
- [ ] **권한 부족 케이스**: 403 응답 (해당하는 경우)
- [ ] **리소스 없음 케이스**: 404 응답 (GET /{id}인 경우)

### 추가 권장 사항
- [ ] 다양한 입력 값으로 여러 번 테스트
- [ ] 경계값 테스트 (최소/최대 길이, null 값 등)
- [ ] 파일 업로드 API는 실제 이미지 파일로 테스트
- [ ] 페이징 API는 다양한 page, size 값으로 테스트
- [ ] 정렬(sort) 파라미터 테스트

---

## 9. 프론트엔드 연동 전 필수 확인

**프론트엔드 개발자가 API를 사용하기 전에:**
1. ✅ Swagger UI에서 API 문서 확인
2. ✅ 예시 요청/응답 포맷 확인
3. ✅ 실제 시험 호출로 동작 검증
4. ✅ 에러 응답 케이스 확인

**이를 통해:**
- API 스펙 불일치로 인한 버그 사전 방지
- 프론트엔드 타입 정의 정확성 향상
- 개발 효율성 향상

---

## 10. Swagger UI 접속 정보

### 로컬 개발 환경
- **Swagger UI**: `http://localhost:8080/swagger-ui/index.html`
- **API Docs (JSON)**: `http://localhost:8080/api-docs`
- **헬스체크**: `http://localhost:8080/api/v1/health`

### 설정 파일
- `application.properties`: `springdoc.swagger-ui.path=/swagger-ui`
- `SecurityConfig.java`: `/swagger-ui/**`, `/api-docs/**` permitAll 설정 확인
- `SwaggerConfig.java`: OpenAPI 설정 확인

---

## See also:
- [304-api-rest-design-rules.cursorrules](304-api-rest-design-rules.cursorrules) - REST API 설계 표준
- [301-spring-boot-java-rules.cursorrules](301-spring-boot-java-rules.cursorrules) - Spring Boot 개발 규칙
- [003-development-guidelines.cursorrules](003-development-guidelines.cursorrules) - 개발 가이드라인
