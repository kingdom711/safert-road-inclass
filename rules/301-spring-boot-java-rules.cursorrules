---
description: Safety Road 백엔드 Java 17 & Spring Boot 3.x 개발 규칙
globs: ["**/*.java"]
alwaysApply: false
---
# Spring Boot & Java Development Rules - Safety Road

## 1. Coding Style & Conventions
- **Class Names**: PascalCase (e.g., `ChecklistService`, `UserRepository`)
- **Method/Variable Names**: camelCase (e.g., `findChecklistById`, `userName`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `MAX_FILE_SIZE`, `DEFAULT_PAGE_SIZE`)
- **Package Naming**: 소문자, 단수형 (e.g., `domain.auth.controller`)
- **Lombok**: `@Data`, `@Builder`, `@RequiredArgsConstructor` 적극 활용
- **Formatting**: Google Java Style Guide (4 spaces indentation)

## 2. Architecture Patterns (Safety Road Specific)
- **Domain-Driven Design (DDD)**:
  ```
  backend/src/main/java/com/jinsung/safety_road_inclass/
  ├── global/          # 공통 관심사 (config, error, common)
  │   ├── config/      # SecurityConfig, WebMvcConfig, JpaAuditingConfig
  │   ├── error/       # GlobalExceptionHandler, ErrorCode
  │   └── common/      # ApiResponse<T>, BaseTimeEntity
  └── domain/          # 비즈니스 도메인 (7개)
      ├── auth/        # 인증/인가 (JWT, User Entity)
      ├── template/    # 체크리스트 템플릿
      ├── checklist/   # 체크리스트 작성 및 저장
      ├── review/      # 검토 및 승인
      ├── risk/        # 위험성 평가
      ├── ai/          # AI 분석 연동
      └── notification/# 알림
  ```
- **Layered Architecture** (각 도메인 내):
  - `controller/`: HTTP 요청/응답 처리 (DTO ↔ Service)
  - `service/`: 비즈니스 로직 (Entity ↔ Repository)
  - `repository/`: 데이터 접근 (Spring Data JPA)
  - `entity/`: JPA 엔티티
  - `dto/`: 요청/응답 DTO (Request, Response)

- **DTO Pattern 필수**:
  - **절대 `@Entity`를 Controller에서 직접 반환하지 말 것**
  - 항상 DTO로 변환 (ModelMapper 또는 수동 매핑)
  - 예: `ChecklistResponse.from(checklist)`

- **Dependency Injection**:
  - **Constructor Injection** 사용 (`@RequiredArgsConstructor` + `final` 필드)
  - `@Autowired` 필드 주입 금지

## 3. Best Practices (Safety Road Context)
- **Exception Handling**:
  - `global.error.GlobalExceptionHandler` (`@RestControllerAdvice`) 활용
  - 커스텀 예외: `CustomException` 상속 (예: `ChecklistNotFoundException`)
  - 응답 포맷: `ApiResponse<T>` 통일
  
- **Validation**:
  - DTO에 `jakarta.validation` 어노테이션 사용 (`@NotNull`, `@NotBlank`, `@Email`)
  - Controller 메서드에 `@Valid` 명시
  
- **Logging**:
  - `@Slf4j` 사용
  - 주요 비즈니스 이벤트 로깅:
    ```java
    log.info("체크리스트 제출 완료: checklistId={}, userId={}", id, userId);
    log.error("AI 분석 실패: photoId={}", photoId, e);
    ```
  
- **Transaction Management**:
  - Service 클래스에 `@Transactional(readOnly = true)` 기본 적용
  - CUD 메서드에만 `@Transactional` 오버라이드
  - 예:
    ```java
    @Service
    @Transactional(readOnly = true)
    @RequiredArgsConstructor
    public class ChecklistService {
        @Transactional
        public ChecklistResponse submit(ChecklistRequest request) { ... }
    }
    ```

- **Security**:
  - `SecurityContextHolder`에서 현재 사용자 정보 조회
  - 권한 검증: `@PreAuthorize("hasRole('ROLE_SUPERVISOR')")`

## 4. Testing Standards
- **Unit Tests**:
  - JUnit 5 + Mockito
  - Service 레이어를 Repository Mock으로 격리 테스트
  - 네이밍: `TargetClass_methodName_scenario_expectedResult`
  - 예: `ChecklistService_submit_whenValidInput_thenReturnChecklistId`

- **Integration Tests**:
  - `@SpringBootTest` + H2 또는 Testcontainers
  - Controller 및 Repository 통합 테스트
  - `@AutoConfigureMockMvc` 활용

## 5. Safety Road Specific Rules
- **Entity 설계**:
  - 모든 Entity는 `BaseTimeEntity` 상속 (`created_at`, `updated_at` 자동 관리)
  - 예:
    ```java
    @Entity
    @Table(name = "checklists")
    public class Checklist extends BaseTimeEntity { ... }
    ```

- **State Management** (체크리스트 상태):
  - Enum 사용: `ChecklistStatus { DRAFT, SUBMITTED, APPROVED, REJECTED }`
  - 상태 전이 로직은 Entity 내부 메서드로 캡슐화:
    ```java
    public void approve() {
        if (this.status != ChecklistStatus.SUBMITTED) {
            throw new IllegalStateException("제출된 상태만 승인 가능합니다");
        }
        this.status = ChecklistStatus.APPROVED;
    }
    ```

- **File Upload**:
  - `MultipartFile` 처리 시 확장자 및 용량 검증
  - 최대 파일 크기: 10MB
  - 허용 확장자: `.jpg`, `.jpeg`, `.png`

## 6. Common Pitfalls (피해야 할 것)
- ❌ Controller에서 Entity 직접 반환
- ❌ `@Autowired` 필드 주입
- ❌ Service 메서드에 `@Transactional` 누락
- ❌ DTO 검증 없이 그대로 Entity로 변환
- ❌ 예외를 catch만 하고 로그 없이 무시

## See also:
- [303-database-mysql-jpa-rules.cursorrules](303-database-mysql-jpa-rules.cursorrules)
- [304-api-rest-design-rules.cursorrules](304-api-rest-design-rules.cursorrules)

